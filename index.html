<html>

 <head>
     <title>Game</title>
     <script type="text/javascript" src="js/dollar.js"></script>
     <script type="text/javascript" src="js/phaser.min.js"></script>
     <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
     <script src="js/shape.js"></script>
 </head>

 <body>
    <script>
        var w = window.innerWidth * window.devicePixelRatio,
        h = window.innerHeight * window.devicePixelRatio;
        var game = new Phaser.Game(w, h, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render });

     var canvas;

    var RIGHT = 1, LEFT = 0;

    var player;
    var platforms;
    var cursors;
    var stars, star;
    var background;
    var boxs, box;
    var enemies, enemy; 
    var ground;

    var score = 0;
    var scoreText;
    var milliseconds = 0;
    var seconds = 0;
    var minutes = 0;
    
    var starH=22;
    var starW=24;

    var playerH = 200;
    var playerW = 300;

    var enemyH = 89;
    var enemyW =89;

    var solidH = 100;
    var solidW = 100;

    var boxH=51;
    var boxW = 50

    var lecters;
    var lecter;
    var shape=[];
    var map;

    var turn = 0;


    function preload() {

        /*Imposta limiti di risoluzione 2048x1536 retina display */
        game.scale.maxWidth = 1920;
        game.scale.maxHeight = 1080;

        /*Vogliamo scalare fino a quando possibile, ma proporzionalmente*/
        game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
        game.scale.setScreenSize();

        
        game.load.image('box', 'assets/box.png');
        game.load.image('forest', 'assets/bk_smaller2.jpg');
        game.load.image('ground', 'assets/solid.jpg');
        game.load.image('star', 'assets/star.png');
        game.load.spritesheet('enemy', 'assets/bombe_.png', enemyW, enemyH);
        game.load.spritesheet('dude', 'assets/player.png', playerW, playerH);
        game.load.image('fumetto', '/assets/fumetto.jpg');
    }


    function create() {
        game.physics.startSystem(Phaser.Physics.ARCADE);                                   //abilito la fisica
        game.world.setBounds(0, 0, 6000, 600);                                             //imposto l'area di copertura della camera

  
        background = game.add.tileSprite(0, 0,w,h,'forest');             
        platforms = game.add.group();                                                      //il platform contiene la terra e le due sporgenze su cui possiamo saltare
        platforms.enableBody = true;                                                       //Noi abiliteremo la fisica per tutti gli oggetti che sono stati creati in questo gruppo

        ground = platforms.create(0, game.world.height - solidH, 'ground');                    //adesso creiamo il ground
        ground.body.immovable = true;                                                      // questo impedisce la caduta del ground

        enemies = game.add.group();
        enemies.enableBody = true;

        lecters = game.add.group();
        lecters.enableBody = true;

        //Creo nemici
        for (var i = 1; i < 3; i++) {
            enemy = enemies.create(i * 1500, game.world.height - enemyH - solidH, 'enemy');
            enemy.body.bounce.y = 0.2;
            enemy.body.collideWorldBounds = true;

            //game.add.sprite(this.posX, this.posY, this.bmd);

        }

        shape[0] = new Shape(i * 1500, game.world.height / 2 - 150 / 2, 200, 150);
        shape[0].initializeBitmapData(game.cache.getImage('fumetto'));
        //lecter = lecters.create(i * 100, game.world.height - shape[0].bitmapH - solidH - enemyH, shape[0].bmd);

        enemies.callAll('animations.add', 'animations', 'left', [1], 10, true);   //invoco la funzione animations.add come se la stessero chiamando i figli del gruppo   
        enemies.callAll('animations.add', 'animations', 'right', [0], 10, true);
 
        player = game.add.sprite(0, game.world.height - solidH-playerH, 'dude');
        game.physics.arcade.enable(player);                                                //abilità la fisica al player

        player.body.bounce.y = 0.2;                                                   /*impostiamo fisica rimbalzo*/
        player.body.gravity.y = 600;                                                        /*impostiamo la gravita*/
        player.body.collideWorldBounds = true;                                             /*impostiamo collisioni*/

        player.animations.add('left', [3,4,5], 10, true);                             //animazione cammina a sinistra
        player.animations.add('right', [0,1,2], 10, true);                            //animazione cammina a destra


        cursors = game.input.keyboard.createCursorKeys();                                  //creiamo i controlli
             



       
        stars = game.add.group();                                                          //creaiamo il gruppo stars
        stars.enableBody = true;                                                           //abilitiamo tutte le stelle che sono state create in questo gruppo

        boxs = game.add.group();
        boxs.enableBody = true;

        /*Creo le stelle*/
        for (var j = 1; j < 100; j=j+20) {
            for (var i = j; i < j+10; i++) {
                star = stars.create(i * 2 * starW, game.world.height - solidH - starH, 'star');                   //creaiamo una star nel gruppo stars
                star.body.gravity.y = 0;                                                        //impostiamo il valore della gravita
                star.body.bounce.y = 0.7 + Math.random() * 0.2;                                 //diamo alla stella un valore di rimbalzo casuale
                star.body.collideWorldBounds = true;                                            //utile altrimenti esistono ma non si vedono(si possono applicare bug e forse consuma risorse)
            }
        }

        /*Creo le scatole*/
        /*for (var i = 1; i < 6; i++) {
            box = boxs.create(1000*i, game.world.height - boxH - solidH, 'box');
            box.body.immovable = true;
        }*/

        scoreText = game.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#000' });//stampo lo score attuale
        scoreText.fixedToCamera = true;

        background.fixedToCamera = true;                                                   //il background è un elemento fisso per la camera
        ground.fixedToCamera = true;                                                       //il ground è un elemento fisso per la camera
        ground.scale.setTo(w /solidW,1);


        game.camera.follow(player);                                                        //la camera deve inseguire il giocatore
        game.camera.deadzone = new Phaser.Rectangle(400, 600, 0, 600);
        
        canvas = document.getElementsByTagName('body')[0];                                 //prelevo la canvas del gioco
        classicalResize();
    }

    function update() {
        
        game.physics.arcade.collide(player,platforms); //collisione tra il personaggio e il platform.
        game.physics.arcade.collide(stars, platforms);
        game.physics.arcade.collide(boxs, platforms);
        game.physics.arcade.collide(boxs, player);
        game.physics.arcade.collide(boxs, stars);
        game.physics.arcade.overlap(player, stars, collectStar, null, this); /* se c'è un overlap tra  players e stars viene invocato il metodo collectStar*/

        
        game.physics.arcade.collide(boxs, enemies);
        game.physics.arcade.collide(enemies, platforms);


        if (game.input.activePointer.isDown) {
            turn=shape[0].captureInputData();
        }

        if (game.input.activePointer.isUp) {
            if (turn == 1) {
                var res = shape[0].checkInputData();
                if (res.point == 0 && res.npoint == 0) {
                    console.log("Error!");
                } else {
                    console.log(" PunteggioTot:(" + (res.point / (res.npoint) * 100) + ")." + " Figura:" + res.type);
                }
                turn = 0;
            }
        }

        if (onSwipeUp() && player.body.touching.down) {
            player.body.velocity.y = -500
        }

        if (onSwipeRight()) {                                                      //Controllo se l'utente fa uno Swap a destra
            player.body.velocity.x = 150;                                          //Muovi a destra
            player.animations.play('right');
        } else if (onSwipeLeft()) {
            player.body.velocity.x = -150;                                         //Muovi a sinistra
            player.animations.play('left');
        }

        for(var i=0; i<2; i++){
            var currentEnemy=enemies.getAt(i);
            game.physics.arcade.overlap(currentEnemy, player, match, null, this);
        }
        
        
        for (var i = 0; i < 2; i++) {
            var posEnemyX = enemies.getAt(i).x;
            if (posEnemyX <= (i+1) * 700) {
                enemies.getAt(i).body.velocity.x = 80;
                enemies.getAt(i).animations.play('right');
            }
            if (posEnemyX >= (i+1) * 880) {
                enemies.getAt(i).body.velocity.x = -80;
                enemies.getAt(i).animations.play('left');
            }
        }
        
        background.tilePosition.x = -game.camera.x; //aggiorno la posizione del background
     
    }
  
  

        function onSwipeUp() {
            return ((game.input.activePointer.positionDown.y - game.input.activePointer.position.y) > 50 && game.input.activePointer.duration > 100 && game.input.activePointer.duration < 250);
        }

        function onSwipeRight() {
            return ((game.input.activePointer.position.x - game.input.activePointer.positionDown.x) > 50 && game.input.activePointer.duration > 100 && game.input.activePointer.duration < 250);
        }

        function onSwipeLeft() {
            return ((game.input.activePointer.positionDown.x - game.input.activePointer.position.x) > 50 && game.input.activePointer.duration > 100 && game.input.activePointer.duration < 250);
        }

        function render() {
            game.debug.cameraInfo(game.camera, 32, 32);
            game.debug.spriteCoords(player, 32, 200);
        }

    function classicalResize() {
        
    }
 
    function collectStar(player, star) {
        star.kill();                                //rimuove la stella in cui c'è stato l'overlap.
        score += 10;                                //aumento lo score di 10 punti
        scoreText.text = 'Score: ' + score;         //inserisco un nuovo valore nella scritta
    }

    function match(enemy, player) {
        if (player.position.y < enemy.position.y-100) {
            enemy.kill();
            score += 20;//aumento di 20 punti
            scoreText.text = 'Score: ' + score; //inserisco un nuovo valore nella scritta
        } else {
            player.kill();
            location.reload();
        }
    }

    </script>
  </body>

 </html>

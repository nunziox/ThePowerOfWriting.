<html>
	
 <head>
     <script type="text/javascript" src="js/phaser.min.js"></script>
 </head>

 <body>
    <script>
     var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

     function preload() {
         game.load.image('box', 'assets/box.jpg');
         game.load.image('forest', 'assets/forest.jpg');
         game.load.image('ground', 'assets/platform.png');
         game.load.image('star', 'assets/star.png');
         game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
     }


     var player;
     var platforms;
     var cursors;
     var stars,star;
     var background;
     var star;
     var boxs,box;
     var ground;

     var milliseconds =0;
     var seconds = 0;
     var minutes = 0;


     function create() {
         game.physics.startSystem(Phaser.Physics.ARCADE); //abilita la fisica

         background = game.add.tileSprite(0, 0, 800, 600, 'forest');

         platforms = game.add.group(); //il platform contiene la terra e le due sporgenze su cui possiamo saltare
         platforms.enableBody = true; //Noi abiliteremo la fisica per tutti gli oggetti che sono stati creati in questo gruppo

         ground = platforms.create(0, game.world.height - 64, 'ground'); //adesso creiamo il ground
         ground.body.immovable = true; // questo impedisce la caduta del ground
 
         player = game.add.sprite(game.world.width/2-30, game.world.height - 150, 'dude');
         game.physics.arcade.enable(player); //abilità la fisica al player

         player.body.bounce.y = 0.2;              /*impostiamo fisica rimbalzo*/
         player.body.gravity.y = 300;             /*impostiamo la gravita*/
         player.body.collideWorldBounds = true;   /*impostiamo collisioni*/
        

         player.animations.add('left', [0, 1, 2, 3], 10, true); //animazione cammina a sinistra
         player.animations.add('right', [5, 6, 7, 8], 10, true); //animazione cammina a destra


         cursors = game.input.keyboard.createCursorKeys(); //creiamo i controlli

         stars = game.add.group(); //creaiamo il gruppo stars
         stars.enableBody = true; //abilitiamo tutte le stelle che sono state create in questo gruppo

         for (var i = 0; i < 12; i++) {
             star = stars.create(i * 70, 0, 'star'); //creaiamo una star nel gruppo stars
             star.body.gravity.y = 300; //impostiamo il valore della gravita
             star.body.bounce.y = 0.7 + Math.random() * 0.2; //diamo alla stella un valore di rimbalzo casuale
         }

         boxs = game.add.group();
         boxs.enableBody = true;

      
         classicalResize();
     }

     function update() {


         game.physics.arcade.collide(boxs, player); //collisione tra il personaggio e il platform.
         game.physics.arcade.collide(player,platforms); //collisione tra il personaggio e il platform.
         game.physics.arcade.collide(boxs,platforms); //collisione tra il personaggio e il platform.
         game.physics.arcade.collide(stars, platforms); //collisione tra le stelle e il platform
         game.physics.arcade.collide(stars,boxs); //collisione tra le stelle e il platform

         game.physics.arcade.overlap(player, stars, collectStar, null, this); /* se c'è un overlap tra  players e stars viene invocato il metodo collectStar*/
    
         player.body.velocity.x = 0; //reset la velocità del player


         if (cursors.left.isDown) {
             //moveNextObject();
             //player.body.velocity.x = -150; //Muovi a sinistra

             player.animations.play('left');
         }
         else if (cursors.right.isDown) {
      

             moveBackObject();

                if(box != undefined){
                 if ((box.x - player.x) > 100) {
                     moveBackObject();
                 }
                }

            
             //player.body.velocity.x =2; //Muovi a destra
       
             player.animations.play('right');
         }
         else {
             player.animations.stop();
             player.frame = 4;
         }

         if (cursors.up.isDown && player.body.touching.down) { //permette di saltare se è premuto il tasto verso l'alto
             player.body.velocity.y = -100;
         }

         if (Math.random()*100<0.2) {
             box = boxs.create(600, game.world.height - 200 * 1 / 4 - 64, 'box'); // Adesso creiamo le due sporgenze
             box.body.immovable = true;
             classicalResize();
         }

     }

     function classicalResize() {
         ground.scale.setTo(2, 2);
         box.scale.setTo(1 / 4, 1 / 4);
     }

     function moveBackObject() {
         background.tilePosition.x -= 4;
         stars.position.x -= 4;
         boxs.position.x -= 4;
     }

     function moveNextObject(){
         background.tilePosition.x += 4;
         stars.position.x += 4;
         box.position.x += 4;
     }

     function collectStar(player, star) {
         star.kill(); //rimuove la stella in cui c'è statop l'overlap.
     }


     function updateTimer() {

         minutes = Math.floor(game.time.time / 60000) % 60;
         seconds = Math.floor(game.time.time / 1000) % 60;
         milliseconds = Math.floor(game.time.time) % 100;

         if (milliseconds < 10)
             milliseconds = '0' + milliseconds;

         if (seconds < 10)
             seconds = '0' + seconds;

         if (minutes < 10)
             minutes = '0' + minutes;

     }

   </script>
 </body>

</html>